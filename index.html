<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã€ŒEMSDè¨»å†Šäººå“¡ã€æŸ¥è©¢ç³»çµ±</title>
    <!-- Awesome Icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" />
    <style>
        .element-hidden {
            display: none !important;
        }

        /* Reset & Base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
            min-height: 100vh;
            padding: 16px;
            color: #1f2937;
        }

        /* Layout */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header h1 {
            color: #111827;
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-align: center;
        }

        .header .subtitle {
            color: #6b7280;
            font-size: 1rem;
            line-height: 1.5;
            text-align: center;
        }

        /* Form Section */
        .form-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-group label i {
            color: #283593;
        }

        .form-control {
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.2s ease;
            background: white;
        }

        .form-control:focus {
            outline: none;
            border-color: #283593;
            box-shadow: 0 0 0 3px rgba(40, 53, 147, 0.1);
        }

        .year-input {
            max-width: 200px;
        }

        .form-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: center;
            margin-top: 10px;
        }

        .btn {
            padding: 12px 28px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #283593 0%, #1a237e 100%);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #3949ab 0%, #1a237e 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 53, 147, 0.3);
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            color: white;
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #ef4444 0%, #991b1b 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.9rem;
        }

        .btn-source {
            flex: 1;
            min-width: 200px;
            justify-content: space-between;
            text-align: left;
        }

        /* Main Content */
        .main-content {
            display: flex;
            flex: 1;
            gap: 20px;
            height: 600px;
        }

        .data-section {
            flex: 1;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            overflow-y: auto;
            min-height: 0;
        }

        /* Data Section Styles */
        .data-header {
            margin-bottom: 20px;
            text-align: center;
        }

        .data-header h2 {
            color: #111827;
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .data-header .subtitle {
            color: #6b7280;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .data-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            background: #f8fafc;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid #e5e7eb;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #283593;
            display: block;
        }

        .stat-label {
            font-size: 0.8rem;
            color: #6b7280;
        }

        .accordion-container {
            margin-top: 20px;
        }

        /* Nested Accordion Styles */
        .accordion-level-1 {
            margin-bottom: 16px;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
        }

        .accordion-level-2,
        .accordion-level-3,
        .accordion-level-4 {
            margin: 0;
            border: none;
            border-radius: 0;
            border-top: 1px solid #e5e7eb;
        }

        .dataset-header {
            background: linear-gradient(135deg, #283593 0%, #1a237e 100%);
            color: white;
            padding: 12px 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            transition: background-color 0.2s ease;
            user-select: none;
        }

        .dataset-header:hover {
            background: linear-gradient(135deg, #3949ab 0%, #1a237e 100%);
        }

        .dataset-header.level-2 {
            background: linear-gradient(135deg, #3949ab 0%, #283593 100%);
        }

        .dataset-header.level-3 {
            background: linear-gradient(135deg, #5c6bc0 0%, #3949ab 100%);
        }

        .dataset-header.level-4 {
            background: linear-gradient(135deg, #7986cb 0%, #5c6bc0 100%);
        }

        .dataset-header i {
            transition: transform 0.3s ease;
        }

        .dataset-header .accordion-icon {
            transition: transform 0.3s ease;
        }

        .dataset-header.collapsed .accordion-icon {
            transform: rotate(-90deg);
        }

        .dataset-content {
            padding: 0;
            background: white;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .dataset-content.expanded {
            max-height: 5000px;
        }

        .person-item {
            border-bottom: 1px solid #e5e7eb;
            padding: 15px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .person-item:last-child {
            border-bottom: none;
        }

        .person-item:hover {
            background-color: #f8fafc;
        }

        .person-item.active {
            background-color: #f0f4ff;
            border-left: 4px solid #283593;
        }

        .person-title {
            font-weight: 600;
            color: #111827;
            margin-bottom: 10px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .person-content {
            color: #4b5563;
            font-size: 0.95rem;
            line-height: 1.6;
        }

        .person-details {
            background: #f8fafc;
            border-top: 1px solid #e5e7eb;
            padding: 15px;
            margin-top: 10px;
            border-radius: 0 0 8px 8px;
        }

        .detail-row {
            display: flex;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #f3f4f6;
        }

        .detail-label {
            font-weight: 600;
            color: #374151;
            width: 150px;
            flex-shrink: 0;
        }

        .detail-value {
            flex: 1;
            color: #6b7280;
            word-break: break-word;
        }

        .no-data {
            text-align: center;
            padding: 40px 20px;
            color: #9ca3af;
        }

        .no-data i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .loading {
            text-align: center;
            padding: 40px 20px;
            color: #6b7280;
        }

        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #283593;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Footer */
        .footer {
            text-align: center;
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.875rem;
            padding: 20px;
            margin-top: auto;
        }

        /* Notification */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 3000;
            animation: slideIn 0.3s ease-out;
        }

        .notification.success {
            background-color: #10b981;
            color: white;
        }

        .notification.error {
            background-color: #ef4444;
            color: white;
        }

        .notification.info {
            background-color: #283593;
            color: white;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }

            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* Data Source Selector */
        .data-source-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .source-btn {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: #f8fafc;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 600;
            color: #374151;
        }

        .source-btn:hover {
            background: #f1f5f9;
            border-color: #cbd5e1;
            transform: translateY(-2px);
        }

        .source-btn.active {
            background: #e0e7ff;
            border-color: #283593;
            color: #283593;
        }

        .source-btn .btn-content {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .source-btn .btn-count {
            background: #283593;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            min-width: 40px;
            text-align: center;
        }

        .source-btn .btn-actions {
            display: flex;
            gap: 8px;
            margin-left: 10px;
        }

        .btn-icon {
            padding: 4px 8px;
            font-size: 0.8rem;
        }

        /* Mobile Optimizations */
        @media (max-width: 768px) {
            body {
                padding: 12px;
                background: #1a237e;
            }

            .container {
                gap: 16px;
            }

            .header {
                padding: 16px;
                border-radius: 12px;
            }

            .header h1 {
                font-size: 1.5rem;
            }

            .form-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .form-section {
                padding: 20px;
            }

            .main-content {
                flex-direction: column;
                height: auto;
            }

            .data-section {
                max-height: 400px;
                min-height: 400px;
                padding: 15px;
            }

            .data-header h2 {
                font-size: 1.3rem;
            }

            .stat-value {
                font-size: 1.5rem;
            }

            .detail-row {
                flex-direction: column;
                margin-bottom: 12px;
            }

            .detail-label {
                width: 100%;
                margin-bottom: 5px;
            }

            .dataset-header {
                padding: 10px 12px;
                font-size: 0.9rem;
            }

            .btn {
                padding: 10px 20px;
                font-size: 0.9rem;
            }

            .data-source-selector {
                grid-template-columns: 1fr;
                max-height: 400px;
                overflow-y: auto;
            }

            .source-btn {
                flex-direction: column;
                align-items: stretch;
            }

            .source-btn .btn-content {
                margin-bottom: 8px;
            }

            .source-btn .btn-actions {
                justify-content: center;
                margin-left: 0;
            }

            .accordion-level-1,
            .accordion-level-2,
            .accordion-level-3,
            .accordion-level-4 {
                margin-bottom: 8px;
            }

            .dataset-content.expanded {
                overflow-y: auto;
                max-height: 500px;
            }
        }

        /* Desktop Enhancements */
        @media (min-width: 1200px) {
            .data-section {
                max-height: 65vh;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header class="header">
            <h1>ã€ŒEMSDè¨»å†Šäººå“¡ã€<br />æŸ¥è©¢ç³»çµ±</h1>
            <p class="subtitle">è³‡è¨Šä¾†æºï¼šæ©Ÿé›»å·¥ç¨‹ç½² (EMSD)</p>
        </header>
        <section class="form-section">
            <div class="data-source-selector" id="data-source-selector">
                <!-- Data sources will be populated by JavaScript -->
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-info"
                    onclick="window.open('https://cors-anywhere.herokuapp.com', '_blank')">
                    å•Ÿç”¨ Proxy
                </button>
                <button type="button" class="btn btn-primary" onclick="loadAllDataSources()">
                    <i class="fas fa-sync-alt"></i>
                    è¼‰å…¥æ‰€æœ‰è³‡æ–™
                </button>
                <button type="button" class="btn btn-secondary" onclick="resetForm()">
                    <i class="fas fa-redo"></i>
                    é‡ç½®
                </button>
                <button type="button" class="btn btn-danger" onclick="clearAllCache()">
                    <i class="fas fa-trash-alt"></i>
                    æ¸…é™¤ç·©å­˜
                </button>
            </div>
        </section>
        <main class="main-content">
            <section class="data-section">
                <div class="data-header">
                    <h2>è¨»å†Šäººå“¡è³‡æ–™</h2>
                    <p class="subtitle">é»æ“Šäººå“¡é …ç›®æŸ¥çœ‹æ›´å¤šè©³ç´°è³‡è¨Š</p>
                </div>
                <div class="data-stats">
                    <div class="stat-item">
                        <span id="total-datasets" class="stat-value">0</span>
                        <span class="stat-label">è³‡æ–™é›†</span>
                    </div>
                    <div class="stat-item">
                        <span id="total-persons" class="stat-value">0</span>
                        <span class="stat-label">è¨»å†Šäººå“¡</span>
                    </div>
                    <div class="stat-item">
                        <span id="cache-status" class="stat-value">-</span>
                        <span class="stat-label">ç·©å­˜ç‹€æ…‹</span>
                    </div>
                </div>
                <div class="accordion-container" id="accordion-container">
                    <div class="no-data">
                        <i class="fas fa-database"></i>
                        <p>è«‹é¸æ“‡è³‡æ–™ä¾†æºä¸¦é»æ“Šã€Œè¼‰å…¥æ‰€æœ‰è³‡æ–™ã€æŒ‰éˆ•é–‹å§‹æŸ¥è©¢</p>
                    </div>
                </div>
            </section>
        </main>
        <footer class="footer">
            <p>ã€ŒEMSDè¨»å†Šäººå“¡ã€æŸ¥è©¢ç³»çµ±<br />è³‡æ–™ä¾†æº: æ©Ÿé›»å·¥ç¨‹ç½² (EMSD)</p>
        </footer>
    </div>
    <script>
        const PROXY_URL = 'https://cors-anywhere.herokuapp.com';
        // æ•¸æ“šæºé…ç½® - åªä¿ç•™æºé ­emoji
        const DATA_SOURCES = [
            {
                id: 'gas_gi',
                name: 'ğŸ”¥ è¨»å†Šæ°£é«”è£ç½®æŠ€å·¥',
                url: 'https://www.emsd.gov.hk/filemanager/en/content_227/dataset/gas_reg_gi.csv',
                type: 'csv',
                enabled: true,
                emoji: 'ğŸ”¥'
            },
            {
                id: 'vehicle_mechanics',
                name: 'ğŸš— è¨»å†Šè»Šè¼›ç¶­ä¿®æŠ€å·¥',
                url: 'https://www.emsd.gov.hk/filemanager/en/content_647/dataset/registered_vehicle_mechanics.csv',
                type: 'csv',
                enabled: true,
                emoji: 'ğŸš—'
            },
            {
                id: 'lift_worker',
                name: 'ğŸ“ˆ è¨»å†Šå‡é™æ©Ÿå·¥ç¨‹äººå“¡',
                url: 'https://www.emsd.gov.hk/filemanager/en/content_808/dataset/registered_lift_worker.json',
                type: 'json',
                enabled: true,
                emoji: 'ğŸ“ˆ'
            },
            {
                id: 'lift_engineer',
                name: 'ğŸ‘¨â€ğŸ”§ è¨»å†Šå‡é™æ©Ÿå·¥ç¨‹å¸«',
                url: 'https://www.emsd.gov.hk/filemanager/en/content_808/dataset/registered_lift_engineer.json',
                type: 'json',
                enabled: true,
                emoji: 'ğŸ‘¨â€ğŸ”§'
            },
            {
                id: 'electrical_worker',
                name: 'âš¡ è¨»å†Šé›»æ¥­å·¥ç¨‹äººå“¡',
                url: 'https://www.emsd.gov.hk/filemanager/en/content_458/dataset/registered_electrical_worker.json',
                type: 'json',
                enabled: true,
                emoji: 'âš¡'
            },
            {
                id: 'escalator_engineer',
                name: 'ğŸ‘¨â€ğŸ”§ è¨»å†Šè‡ªå‹•æ¢¯å·¥ç¨‹å¸«',
                url: 'https://www.emsd.gov.hk/filemanager/en/content_808/dataset/registered_escalator_engineer.json',
                type: 'json',
                enabled: true,
                emoji: 'ğŸ‘¨â€ğŸ”§'
            },
            {
                id: 'escalator_worker',
                name: 'ğŸ“ˆ è¨»å†Šè‡ªå‹•æ¢¯å·¥ç¨‹äººå“¡',
                url: 'https://www.emsd.gov.hk/filemanager/en/content_808/dataset/registered_escalator_worker.json',
                type: 'json',
                enabled: true,
                emoji: 'ğŸ“ˆ'
            },
            {
                id: 'hac_mfr',
                name: 'â„ï¸ è¨»å†Šå®¶ç”¨å†·æ°£æ©Ÿè¼•åº¦æ˜“ç‡ƒé›ªç¨®è™•ç†å·¥ç¨‹äººå“¡',
                url: 'https://www.emsd.gov.hk/filemanager/en/content_1188/dataset/rthmfr-hac.csv',
                type: 'csv',
                enabled: true,
                emoji: 'â„ï¸'
            },
            {
                id: 'bltwp_inspector',
                name: 'ğŸ—ï¸ å»ºç¯‰å·¥åœ°å‡é™æ©ŸåŠå¡”å¼å·¥ä½œå°çš„è¨»å†Šæª¢é©—å“¡',
                url: 'https://www.emsd.gov.hk/filemanager/tc/content_608/dataset/re_bltwp_tc.csv',
                type: 'csv',
                enabled: true,
                emoji: 'ğŸ—ï¸'
            }
        ];
        // IndexedDB é…ç½®
        const DB_NAME = 'emsd-registry-db';
        const DB_VERSION = 2;
        let db;
        // å…¨å±€è®Šé‡
        let allData = {};
        let currentDataSource = null;
        let cacheStatus = {};
        let personIndexMap = {}; // ç”¨æ–¼æ˜ å°„äººå“¡åˆ°åŸå§‹æ•¸æ“š
        // åˆå§‹åŒ–æ‡‰ç”¨
        document.addEventListener('DOMContentLoaded', function () {
            initIndexedDB();
            renderDataSourceButtons();
            // æª¢æŸ¥ç·©å­˜ç‹€æ…‹
            checkCacheStatus();
            // åˆå§‹åŒ–æ•™ç¨‹
            if (!localStorage.getItem('emsdTutorialShown')) {
                setTimeout(() => {
                    alert("æ­¡è¿ä½¿ç”¨ã€ŒEMSDè¨»å†Šäººå“¡ã€æŸ¥è©¢ç³»çµ±ï¼\n\nâ€¢ é»æ“Šè³‡æ–™ä¾†æºæŒ‰éˆ•è¼‰å…¥å–®å€‹è³‡æ–™é›†\nâ€¢ é»æ“Šã€Œè¼‰å…¥æ‰€æœ‰è³‡æ–™ã€è¼‰å…¥æ‰€æœ‰å·²é¸è³‡æ–™é›†\nâ€¢ é»æ“Šå„ç´šæ¨™é¡Œå¯å±•é–‹/æ”¶èµ·è©²é¡åˆ¥äººå“¡\nâ€¢ é»æ“Šäººå“¡é …ç›®å¯æŸ¥çœ‹è©³ç´°è³‡è¨Š\nâ€¢ è³‡æ–™æœƒè‡ªå‹•ç·©å­˜åœ¨ç€è¦½å™¨ä¸­ï¼Œä¸‹æ¬¡æŸ¥è©¢ç„¡éœ€é‡æ–°ä¸‹è¼‰\nâ€¢ é»æ“Šã€Œæ¸…é™¤ç·©å­˜ã€å¯åˆªé™¤æ‰€æœ‰æœ¬åœ°ç·©å­˜è³‡æ–™");
                    localStorage.setItem('emsdTutorialShown', 'true');
                }, 1000);
            }
        });
        // åˆå§‹åŒ– IndexedDB
        function initIndexedDB() {
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            request.onerror = function (event) {
                console.error('IndexedDB åˆå§‹åŒ–å¤±æ•—:', event.target.error);
                showNotification('ç€è¦½å™¨è³‡æ–™åº«åˆå§‹åŒ–å¤±æ•—ï¼Œå°‡ä½¿ç”¨åœ¨ç·šè³‡æ–™', 'error');
            };
            request.onsuccess = function (event) {
                db = event.target.result;
                console.log('IndexedDB åˆå§‹åŒ–æˆåŠŸ');
                updateCacheStatus();
            };
            request.onupgradeneeded = function (event) {
                const db = event.target.result;
                // ç‚ºæ¯å€‹æ•¸æ“šæºå‰µå»ºå°è±¡å­˜å„²
                DATA_SOURCES.forEach(source => {
                    if (!db.objectStoreNames.contains(source.id)) {
                        const store = db.createObjectStore(source.id, { keyPath: 'id' });
                        store.createIndex('timestamp', 'timestamp', { unique: false });
                    }
                });
                // å‰µå»ºç·©å­˜ç‹€æ…‹å­˜å„²
                if (!db.objectStoreNames.contains('cache_status')) {
                    const statusStore = db.createObjectStore('cache_status', { keyPath: 'sourceId' });
                    statusStore.createIndex('timestamp', 'timestamp', { unique: false });
                }
            };
        }
        // æ¸²æŸ“æ•¸æ“šæºæŒ‰éˆ•
        function renderDataSourceButtons() {
            const container = document.getElementById('data-source-selector');
            container.innerHTML = '';
            DATA_SOURCES.forEach((source, index) => {
                const button = document.createElement('div');
                button.className = 'source-btn';
                button.id = `source-btn-${source.id}`;
                button.innerHTML = `
                    <div class="btn-content">
                        <i class="fas fa-${source.type === 'csv' ? 'file-csv' : 'file-code'}"></i>
                        <span>${source.name}</span>
                    </div>
                    <div class="btn-actions">
                        <span class="btn-count" id="count-${source.id}">0</span>
                        <button class="btn btn-primary btn-icon" onclick="event.stopPropagation(); loadDataSourceById('${source.id}')">
                            <i class="fas fa-download"></i>
                        </button>
                        <button class="btn btn-secondary btn-icon" onclick="event.stopPropagation(); refreshDataSource('${source.id}')">
                            <i class="fas fa-sync"></i>
                        </button>
                    </div>
                `;
                button.onclick = () => toggleDataSource(source.id);
                container.appendChild(button);
            });
        }
        // åˆ‡æ›æ•¸æ“šæºå•Ÿç”¨ç‹€æ…‹
        function toggleDataSource(sourceId) {
            const source = DATA_SOURCES.find(s => s.id === sourceId);
            if (source) {
                source.enabled = !source.enabled;
                const button = document.getElementById(`source-btn-${sourceId}`);
                if (source.enabled) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            }
        }
        // æª¢æŸ¥ç·©å­˜ç‹€æ…‹
        async function checkCacheStatus() {
            if (!db) return;
            cacheStatus = {};
            const promises = DATA_SOURCES.map(source =>
                getFromIndexedDB(source.id).then(data => {
                    cacheStatus[source.id] = data ? 'cached' : 'not_cached';
                    updateSourceCount(source.id, data ? data.data.length : 0);
                    // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
                    const button = document.getElementById(`source-btn-${source.id}`);
                    if (button) {
                        if (cacheStatus[source.id] === 'cached') {
                            button.classList.add('active');
                        }
                    }
                })
            );
            await Promise.all(promises);
            updateCacheStatus();
        }
        // å¾ IndexedDB ç²å–è³‡æ–™
        function getFromIndexedDB(sourceId) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    resolve(null);
                    return;
                }
                const transaction = db.transaction([sourceId], 'readonly');
                const store = transaction.objectStore(sourceId);
                const request = store.getAll();
                request.onsuccess = function (event) {
                    if (event.target.result.length > 0) {
                        // ç²å–æœ€æ–°çš„ç·©å­˜
                        const latest = event.target.result.sort((a, b) =>
                            new Date(b.timestamp) - new Date(a.timestamp)
                        )[0];
                        resolve(latest);
                    } else {
                        resolve(null);
                    }
                };
                request.onerror = function (event) {
                    reject(event.target.error);
                };
            });
        }
        // å„²å­˜åˆ° IndexedDB
        function saveToIndexedDB(sourceId, data) {
            if (!db) return;
            const transaction = db.transaction([sourceId, 'cache_status'], 'readwrite');
            const store = transaction.objectStore(sourceId);
            const statusStore = transaction.objectStore('cache_status');
            const record = {
                id: `${sourceId}-${new Date().getTime()}`,
                sourceId: sourceId,
                data: data,
                timestamp: new Date().toISOString()
            };
            store.add(record);
            // æ›´æ–°ç·©å­˜ç‹€æ…‹
            statusStore.put({
                sourceId: sourceId,
                timestamp: new Date().toISOString(),
                count: data.length
            });
            transaction.oncomplete = function () {
                console.log(`${sourceId} è³‡æ–™å·²å„²å­˜åˆ° IndexedDB`);
                cacheStatus[sourceId] = 'cached';
                updateSourceCount(sourceId, data.length);
                updateCacheStatus();
                // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
                const button = document.getElementById(`source-btn-${sourceId}`);
                if (button) {
                    button.classList.add('active');
                }
            };
            transaction.onerror = function (event) {
                console.error('å„²å­˜åˆ° IndexedDB å¤±æ•—:', event.target.error);
            };
        }
        // æ›´æ–°æ•¸æ“šæºè¨ˆæ•¸
        function updateSourceCount(sourceId, count) {
            const countElement = document.getElementById(`count-${sourceId}`);
            if (countElement) {
                countElement.textContent = count;
            }
        }
        // æ›´æ–°ç·©å­˜ç‹€æ…‹é¡¯ç¤º
        function updateCacheStatus() {
            const cachedCount = Object.values(cacheStatus).filter(status => status === 'cached').length;
            const totalCount = DATA_SOURCES.length;
            document.getElementById('cache-status').textContent = `${cachedCount}/${totalCount}`;
        }
        // è¼‰å…¥æ‰€æœ‰æ•¸æ“šæº
        async function loadAllDataSources() {
            const enabledSources = DATA_SOURCES.filter(source => source.enabled);
            if (enabledSources.length === 0) {
                showNotification('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹è³‡æ–™ä¾†æº', 'error');
                return;
            }
            const container = document.getElementById('accordion-container');
            container.innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>æ­£åœ¨è¼‰å…¥è¨»å†Šäººå“¡è³‡æ–™...</p>
                </div>
            `;
            allData = {};
            let totalPersons = 0;
            // è¼‰å…¥æ¯å€‹å•Ÿç”¨çš„æ•¸æ“šæº
            for (const source of enabledSources) {
                try {
                    const data = await loadDataSource(source);
                    allData[source.id] = {
                        name: source.name,
                        data: data
                    };
                    totalPersons += data.length;
                } catch (error) {
                    console.error(`è¼‰å…¥ ${source.name} å¤±æ•—:`, error);
                    showNotification(`${source.name} è¼‰å…¥å¤±æ•—`, 'error');
                }
            }
            updateStatistics(totalPersons);
            updatePersonList();
            showNotification('è³‡æ–™è¼‰å…¥å®Œæˆ', 'success');
        }
        // è¼‰å…¥æŒ‡å®šæ•¸æ“šæºï¼ˆæŒ‰éˆ•é»æ“Šï¼‰
        async function loadDataSourceById(sourceId) {
            const source = DATA_SOURCES.find(s => s.id === sourceId);
            if (!source) {
                showNotification('æ‰¾ä¸åˆ°æŒ‡å®šçš„è³‡æ–™ä¾†æº', 'error');
                return;
            }
            // å•Ÿç”¨è©²æ•¸æ“šæº
            source.enabled = true;
            const button = document.getElementById(`source-btn-${sourceId}`);
            button.classList.add('active');
            // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
            const container = document.getElementById('accordion-container');
            container.innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>æ­£åœ¨è¼‰å…¥ ${source.name} è³‡æ–™...</p>
                </div>
            `;
            try {
                const data = await loadDataSource(source);
                // æ¸…ç©ºç¾æœ‰æ•¸æ“šï¼Œåªé¡¯ç¤ºç•¶å‰æ•¸æ“šæº
                allData = {};
                allData[source.id] = {
                    name: source.name,
                    data: data
                };
                updateStatistics(data.length);
                updatePersonList();
                showNotification(`${source.name} è¼‰å…¥å®Œæˆ (${data.length} ç­†è³‡æ–™)`, 'success');
            } catch (error) {
                console.error(`è¼‰å…¥ ${source.name} å¤±æ•—:`, error);
                // showNotification(`${source.name} è¼‰å…¥å¤±æ•—`, 'error');
                // container.innerHTML = `
                //     <div class="no-data">
                //         <i class="fas fa-exclamation-circle"></i>
                //         <p>${source.name} è¼‰å…¥å¤±æ•—</p>
                //         <p style="font-size: 0.9rem; margin-top: 10px;">${error.message}</p>
                //     </div>
                // `;
                container.innerHTML = `
                        <div class="no-data">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>è«‹å…ˆè¨ªå• <a href="${PROXY_URL}" target="_blank">${PROXY_URL}</a></p>
                            <p style="font-size: 0.9rem; margin-top: 10px;">é»æ“Šã€ŒRequest temporary access to the demo serverã€æŒ‰éˆ•å•Ÿç”¨ä»£ç†ä¼ºæœå™¨</p>
                        </div>
                    `;
                showNotification('è«‹å•Ÿç”¨ CORS Anywhere ä»£ç†ä¼ºæœå™¨', 'error');
            }
        }
        // åˆ·æ–°æ•¸æ“šæºï¼ˆå¼·åˆ¶å¾ API é‡æ–°è¼‰å…¥ï¼‰
        async function refreshDataSource(sourceId) {
            const source = DATA_SOURCES.find(s => s.id === sourceId);
            if (!source) return;
            // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
            showNotification(`æ­£åœ¨åˆ·æ–° ${source.name}...`, 'info');
            // å¼·åˆ¶å¾ API è¼‰å…¥ï¼ˆè·³éç·©å­˜ï¼‰
            try {
                const data = await loadDataSourceFromAPI(source);
                if (data && data.length > 0) {
                    saveToIndexedDB(source.id, data);
                    showNotification(`${source.name} åˆ·æ–°æˆåŠŸ (${data.length} ç­†è³‡æ–™)`, 'success');
                    // å¦‚æœç•¶å‰é¡¯ç¤ºæ­¤æ•¸æ“šæºï¼Œå‰‡æ›´æ–°é¡¯ç¤º
                    if (allData[source.id]) {
                        allData[source.id].data = data;
                        updatePersonList();
                    }
                }
            } catch (error) {
                console.error(`åˆ·æ–° ${source.name} å¤±æ•—:`, error);
                showNotification(`${source.name} åˆ·æ–°å¤±æ•—`, 'error');
            }
        }
        // è¼‰å…¥å–®å€‹æ•¸æ“šæºï¼ˆä½¿ç”¨ç·©å­˜å„ªå…ˆç­–ç•¥ï¼‰
        async function loadDataSource(source) {
            // å…ˆå˜—è©¦å¾ IndexedDB è¼‰å…¥
            if (db) {
                const cachedData = await getFromIndexedDB(source.id);
                if (cachedData) {
                    console.log(`å¾ç·©å­˜è¼‰å…¥ ${source.name}`);
                    showNotification(`${source.name} å¾ç·©å­˜è¼‰å…¥ (${cachedData.data.length} ç­†è³‡æ–™)`, 'info');
                    return cachedData.data;
                }
            }
            // å¾ API è¼‰å…¥è³‡æ–™
            console.log(`å¾ API è¼‰å…¥ ${source.name}`);
            return await loadDataSourceFromAPI(source);
        }
        // å¾ API è¼‰å…¥è³‡æ–™ï¼ˆä¸æª¢æŸ¥ç·©å­˜ï¼‰
        async function loadDataSourceFromAPI(source) {
            const url = `${PROXY_URL}/${source.url}`;
            const container = document.getElementById('accordion-container');
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    // container.innerHTML = `
                    //     <div class="no-data">
                    //         <i class="fas fa-exclamation-triangle"></i>
                    //         <p>è«‹å…ˆè¨ªå• <a href="${PROXY_URL}" target="_blank">${PROXY_URL}</a></p>
                    //         <p style="font-size: 0.9rem; margin-top: 10px;">é»æ“Šã€ŒRequest temporary access to the demo serverã€æŒ‰éˆ•å•Ÿç”¨ä»£ç†ä¼ºæœå™¨</p>
                    //     </div>
                    // `;
                    // showNotification('è«‹å•Ÿç”¨ CORS Anywhere ä»£ç†ä¼ºæœå™¨', 'error');
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const text = await response.text();
                let data;
                if (source.type === 'csv') {
                    data = parseCSV(text, source.id);
                } else if (source.type === 'json') {
                    data = parseJSON(text, source.id);
                }
                // å„²å­˜åˆ° IndexedDB
                if (data && data.length > 0) {
                    saveToIndexedDB(source.id, data);
                }
                showNotification(`${source.name} å¾ä¼ºæœå™¨è¼‰å…¥æˆåŠŸ (${data.length} ç­†è³‡æ–™)`, 'success');
                return data || [];
            } catch (error) {
                console.error(`å¾ API è¼‰å…¥ ${source.name} å¤±æ•—:`, error);
                showNotification(`è«‹è¨ªå• <a href="${PROXY_URL}" target="_blank">${PROXY_URL}</a> å•Ÿç”¨ CORS ä»£ç†`, 'error');
                throw error;
            }
        }
        // è§£æ CSV æ•¸æ“š - ç¢ºä¿æ‰€æœ‰å¿…è¦å­—æ®µéƒ½è¢«æ­£ç¢ºè§£æ
        function parseCSV(csvText, sourceId) {
            const lines = csvText.split('\n');
            if (lines.length < 2) return [];
            // è§£ææ¨™é ­
            const headers = parseCSVLine(lines[0]);
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                const values = parseCSVLine(line);
                if (values.length === headers.length) {
                    const item = {};
                    headers.forEach((header, index) => {
                        item[header] = values[index];
                    });

                    // æ ¹æ“šæ•¸æ“šæºé¡å‹è™•ç†æ•¸æ“š
                    switch (sourceId) {
                        case 'gas_gi':
                            item.classes = [];
                            for (let i = 1; i <= 8; i++) {
                                if (item[`Class ${i}`] === 'Y') {
                                    item.classes.push(i.toString());
                                }
                            }
                            break;
                        case 'vehicle_mechanics':
                            item.year = item['Expiry Date'] ? item['Expiry Date'].split('/')[2] : '';
                            // è™•ç† Registered Service Class å’Œ Service Scope
                            if (item['Registered Service Class']) {
                                item.serviceClasses = item['Registered Service Class']
                                    .split(',')
                                    .map(cls => cls.trim())
                                    .filter(cls => cls);
                            }
                            if (item['Service Scope']) {
                                item.serviceScopes = item['Service Scope']
                                    .split(',')
                                    .map(scope => scope.trim())
                                    .filter(scope => scope);
                            }
                            break;
                        case 'hac_mfr':
                            item.year = item['Expiry Date'] ? item['Expiry Date'].split('-')[0] : '';
                            item.registeredClass = item['Registered Class'] || 'æœªåˆ†é¡';
                            break;
                        case 'bltwp_inspector':
                            item.year = item['è¨»å†Šæœ‰æ•ˆåˆ°æœŸæ—¥'] ? item['è¨»å†Šæœ‰æ•ˆåˆ°æœŸæ—¥'].split('-')[0] : '';
                            break;
                    }
                    data.push(item);
                }
            }
            return data;
        }
        // çµ±ä¸€å¹´ä»½æå–å‡½æ•¸ - ç¢ºä¿æ‰€æœ‰åœ°æ–¹ä½¿ç”¨ç›¸åŒçš„é‚è¼¯
        function extractYear(person, sourceId) {
            const expiryDate = person['Expiry Date'] || person['è¨»å†Šæœ‰æ•ˆåˆ°æœŸæ—¥'] || '';
            if (expiryDate) {
                if (expiryDate.includes('/')) {
                    return expiryDate.split('/')[2];
                } else if (expiryDate.includes('-')) {
                    return expiryDate.split('-')[0];
                }
            }
            return '';
        }
        // è§£æ CSV è¡Œï¼ˆè™•ç†å¼•è™Ÿï¼‰
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            return result.map(cell => cell.replace(/^"|"$/g, '').trim());
        }
        // è§£æ JSON æ•¸æ“š - ç¢ºä¿æ‰€æœ‰å¿…è¦å­—æ®µéƒ½è¢«æ­£ç¢ºè§£æ
        function parseJSON(jsonText, sourceId) {
            try {
                const jsonData = JSON.parse(jsonText);
                let dataArray = [];

                // æª¢æ¸¬æ•¸æ“šçµæ§‹é¡å‹
                if (sourceId === 'electrical_worker') {
                    // é›»æ¥­å·¥ç¨‹äººå“¡çš„ç‰¹æ®Šæ ¼å¼è™•ç†
                    const headers = jsonData.Header && jsonData.Header[0] ? (
                        typeof jsonData.Header[0] === 'string'
                            ? jsonData.Header
                            : jsonData.Header[0]
                    ) : jsonData.Header;
                    if (!headers || !Array.isArray(headers)) {
                        console.warn('é›»æ¥­å·¥ç¨‹äººå“¡æ¨™é ­æ ¼å¼éŒ¯èª¤:', headers);
                        return [];
                    }

                    dataArray = jsonData.Data.map(row => {
                        const item = {};
                        headers.forEach((header, index) => {
                            item[header] = row[index] || '';
                        });
                        // æå–è¨±å¯å·¥ä½œé¡åˆ¥
                        item.permittedWorks = [];
                        headers.forEach(header => {
                            if (header && header.startsWith('Permitted Work ') && row[headers.indexOf(header)] === 'Y') {
                                const workCode = header.replace('Permitted Work ', '');
                                item.permittedWorks.push(workCode);
                            }
                        });
                        // ä¿®å¾©å¹´ä»½æå–
                        const expiryDate = item['Expiry Date'] || '';
                        if (expiryDate) {
                            if (expiryDate.includes('/')) {
                                item.year = expiryDate.split('/')[2];
                            } else if (expiryDate.includes('-')) {
                                item.year = expiryDate.split('-')[0];
                            } else {
                                item.year = '';
                            }
                        } else {
                            item.year = '';
                        }
                        return item;
                    });
                } else if (['lift_engineer', 'escalator_engineer'].includes(sourceId)) {
                    // å‡é™æ©Ÿ/è‡ªå‹•æ¢¯å·¥ç¨‹å¸«
                    const headers = Array.isArray(jsonData.Header) ? jsonData.Header : (jsonData.Header || []);
                    dataArray = jsonData.Data.map(row => {
                        const item = {};
                        headers.forEach((header, index) => {
                            item[header] = row[index] || '';
                        });
                        // ä¿®å¾©å¹´ä»½æå–
                        const expiryDate = item['ExpiryDate'] || item['Expiry Date'] || '';
                        if (expiryDate) {
                            if (expiryDate.includes('/')) {
                                item.year = expiryDate.split('/')[2];
                            } else if (expiryDate.includes('-')) {
                                item.year = expiryDate.split('-')[0];
                            } else {
                                item.year = '';
                            }
                        } else {
                            item.year = '';
                        }
                        return item;
                    });
                } else {
                    // å…¶ä»– JSON æ•¸æ“šæº
                    const headers = Array.isArray(jsonData.Header) ? jsonData.Header : (jsonData.Header || []);
                    dataArray = jsonData.Data.map(row => {
                        const item = {};
                        headers.forEach((header, index) => {
                            item[header] = row[index] || '';
                        });
                        // æ ¹æ“šæ•¸æ“šæºè™•ç†
                        if (['lift_worker', 'escalator_worker'].includes(sourceId)) {
                            item.classes = [];
                            if (item['Class A'] === 'Y') item.classes.push('A');
                            if (item['Class B'] === 'Y') item.classes.push('B');
                            if (item['Class C'] === 'Y') item.classes.push('C');

                            // ä¿®å¾©å¹´ä»½æå–
                            const expiryDate = item['Expiry Date'] || '';
                            if (expiryDate) {
                                if (expiryDate.includes('/')) {
                                    item.year = expiryDate.split('/')[2];
                                } else if (expiryDate.includes('-')) {
                                    item.year = expiryDate.split('-')[0];
                                } else {
                                    item.year = '';
                                }
                            } else {
                                item.year = '';
                            }
                        }
                        return item;
                    });
                }
                return dataArray;
            } catch (error) {
                console.error('è§£æ JSON å¤±æ•—:', error);
                console.error('å¤±æ•—çš„ JSON æ•¸æ“šç‰‡æ®µ:', jsonText.substring(0, 500));
                return [];
            }
        }
        // æ›´æ–°çµ±è¨ˆæ•¸æ“š
        function updateStatistics(totalPersons) {
            const totalDatasets = Object.keys(allData).length;
            document.getElementById('total-datasets').textContent = totalDatasets;
            document.getElementById('total-persons').textContent = totalPersons;
        }
        // æ›´æ–°äººå“¡åˆ—è¡¨ï¼ˆä½¿ç”¨å››å±¤ Accordionï¼‰- ä¿®å¾©ï¼šä½¿ç”¨åŸå§‹äººå“¡å°è±¡
        function updatePersonList() {
            const container = document.getElementById('accordion-container');
            if (Object.keys(allData).length === 0) {
                container.innerHTML = `
                    <div class="no-data">
                        <i class="fas fa-database"></i>
                        <p>æ²’æœ‰æ‰¾åˆ°è¨»å†Šäººå“¡è³‡æ–™</p>
                        <p style="font-size: 0.9rem; margin-top: 10px;">è«‹ç¢ºèªè³‡æ–™ä¾†æºæ˜¯å¦æ­£ç¢ºæˆ–ç¨å¾Œå†è©¦</p>
                    </div>
                `;
                return;
            }

            // é‡ç½®äººå“¡ç´¢å¼•æ˜ å°„
            personIndexMap = {};

            let accordionHTML = '';
            Object.keys(allData).forEach((sourceId) => {
                const sourceData = allData[sourceId];
                const persons = sourceData.data;
                if (persons.length === 0) {
                    accordionHTML += `
                        <div class="accordion-level-1">
                            <div class="dataset-header" onclick="toggleAccordion(this)">
                                <div>
                                    ${getIconByLevelAndType(1, '', sourceId)}
                                    <span>${sourceData.name.replace(/[ğŸ”¥ğŸš—ğŸ“ˆğŸ‘¨â€ğŸ”§âš¡â„ï¸ğŸ—ï¸]/g, '').trim()} (0)</span>
                                </div>
                                <i class="fas fa-chevron-down accordion-icon"></i>
                            </div>
                            <div class="dataset-content">
                                <div class="no-data" style="padding: 20px;">
                                    <i class="fas fa-exclamation-circle"></i>
                                    <p>æ­¤è³‡æ–™é›†ç›®å‰æ²’æœ‰è³‡æ–™</p>
                                </div>
                            </div>
                        </div>
                    `;
                    return;
                }

                // ç‚ºæ¯å€‹æ•¸æ“šæºå‰µå»ºäººå“¡ç´¢å¼•æ˜ å°„
                personIndexMap[sourceId] = {};

                // æ ¹æ“šæ•¸æ“šæºé¡å‹åˆ†çµ„ - ä¿®å¾©ï¼šä½¿ç”¨åŸå§‹äººå“¡ç´¢å¼•
                let groupedData = {};

                persons.forEach((person, originalIndex) => {
                    // ä¿å­˜åŸå§‹ç´¢å¼•
                    personIndexMap[sourceId][originalIndex] = person;

                    // æ ¹æ“šæ•¸æ“šæºé¡å‹é€²è¡Œåˆ†çµ„
                    const year = extractYear(person, sourceId);

                    switch (sourceId) {
                        case 'gas_gi':
                            // å››å±¤åˆ†çµ„ï¼šæ•¸æ“šæº -> Class -> å¹´åˆ† -> äººå“¡ç´¢å¼•
                            const classes = person.classes || [];
                            if (classes.length === 0) {
                                // const classKey = 'æœªåˆ†é¡';
                                const classKey = 'æ²’æœ‰ç‰Œç…§';
                                if (!groupedData[classKey]) groupedData[classKey] = {};
                                const yearKey = year || 'ç„¡å¹´ä»½';
                                if (!groupedData[classKey][yearKey]) groupedData[classKey][yearKey] = [];
                                groupedData[classKey][yearKey].push(originalIndex);
                            } else {
                                classes.forEach(cls => {
                                    const classKey = `Class ${cls}`;
                                    if (!groupedData[classKey]) groupedData[classKey] = {};
                                    const yearKey = year || 'ç„¡å¹´ä»½';
                                    if (!groupedData[classKey][yearKey]) groupedData[classKey][yearKey] = [];
                                    groupedData[classKey][yearKey].push(originalIndex);
                                });
                            }
                            break;

                        case 'vehicle_mechanics':
                            // å››å±¤åˆ†çµ„ï¼šæ•¸æ“šæº -> Registered Service Class -> Service Scope -> å¹´åˆ† -> äººå“¡ç´¢å¼•
                            const serviceClasses = person.serviceClasses || [];
                            const serviceScopes = person.serviceScopes || [];

                            if (serviceClasses.length === 0 && serviceScopes.length === 0) {
                                const classKey = 'æœªåˆ†é¡';
                                const scopeKey = 'æœªåˆ†é¡';
                                if (!groupedData[classKey]) groupedData[classKey] = {};
                                if (!groupedData[classKey][scopeKey]) groupedData[classKey][scopeKey] = {};
                                if (!groupedData[classKey][scopeKey][year]) groupedData[classKey][scopeKey][year] = [];
                                groupedData[classKey][scopeKey][year].push(originalIndex);
                            } else {
                                const classesToUse = serviceClasses.length > 0 ? serviceClasses : ['æœªåˆ†é¡'];
                                const scopesToUse = serviceScopes.length > 0 ? serviceScopes : ['æœªåˆ†é¡'];

                                classesToUse.forEach(cls => {
                                    scopesToUse.forEach(scope => {
                                        const classKey = cls;
                                        const scopeKey = scope;
                                        if (!groupedData[classKey]) groupedData[classKey] = {};
                                        if (!groupedData[classKey][scopeKey]) groupedData[classKey][scopeKey] = {};
                                        if (!groupedData[classKey][scopeKey][year]) groupedData[classKey][scopeKey][year] = [];
                                        groupedData[classKey][scopeKey][year].push(originalIndex);
                                    });
                                });
                            }
                            break;

                        case 'lift_worker':
                        case 'escalator_worker':
                            // å››å±¤åˆ†çµ„ï¼šæ•¸æ“šæº -> Class -> å¹´åˆ† -> äººå“¡ç´¢å¼•
                            const workerClasses = person.classes || [];
                            if (workerClasses.length === 0) {
                                const classKey = 'æœªåˆ†é¡';
                                if (!groupedData[classKey]) groupedData[classKey] = {};
                                const yearKey = year || 'ç„¡å¹´ä»½';
                                if (!groupedData[classKey][yearKey]) groupedData[classKey][yearKey] = [];
                                groupedData[classKey][yearKey].push(originalIndex);
                            } else {
                                workerClasses.forEach(cls => {
                                    const classKey = `Class ${cls}`;
                                    if (!groupedData[classKey]) groupedData[classKey] = {};
                                    const yearKey = year || 'ç„¡å¹´ä»½';
                                    if (!groupedData[classKey][yearKey]) groupedData[classKey][yearKey] = [];
                                    groupedData[classKey][yearKey].push(originalIndex);
                                });
                            }
                            break;

                        case 'lift_engineer':
                        case 'escalator_engineer':
                            // å…©å±¤åˆ†çµ„ï¼šæ•¸æ“šæº -> å¹´åˆ† -> äººå“¡ç´¢å¼•
                            const yearKey = year || 'ç„¡å¹´ä»½';
                            if (!groupedData[yearKey]) groupedData[yearKey] = [];
                            groupedData[yearKey].push(originalIndex);
                            break;

                        case 'electrical_worker':
                            // å››å±¤åˆ†çµ„ï¼šæ•¸æ“šæº -> Permitted Work -> Grade Code -> å¹´åˆ† -> äººå“¡ç´¢å¼•
                            const works = person.permittedWorks || [];
                            const grade = person['Grade Code'] || 'ç„¡ç´šåˆ¥';

                            if (works.length === 0) {
                                const workKey = 'æœªåˆ†é¡';
                                if (!groupedData[workKey]) groupedData[workKey] = {};
                                if (!groupedData[workKey][grade]) groupedData[workKey][grade] = {};
                                if (!groupedData[workKey][grade][year]) groupedData[workKey][grade][year] = [];
                                groupedData[workKey][grade][year].push(originalIndex);
                            } else {
                                works.forEach(work => {
                                    const workKey = `Permitted Work ${work}`;
                                    if (!groupedData[workKey]) groupedData[workKey] = {};
                                    if (!groupedData[workKey][grade]) groupedData[workKey][grade] = {};
                                    if (!groupedData[workKey][grade][year]) groupedData[workKey][grade][year] = [];
                                    groupedData[workKey][grade][year].push(originalIndex);
                                });
                            }
                            break;

                        case 'hac_mfr':
                            // ä¸‰å±¤åˆ†çµ„ï¼šæ•¸æ“šæº -> Registered Class -> å¹´åˆ† -> äººå“¡ç´¢å¼•
                            const registeredClass = person.registeredClass || 'æœªåˆ†é¡';
                            const mfrYearKey = year || 'ç„¡å¹´ä»½';
                            if (!groupedData[registeredClass]) groupedData[registeredClass] = {};
                            if (!groupedData[registeredClass][mfrYearKey]) groupedData[registeredClass][mfrYearKey] = [];
                            groupedData[registeredClass][mfrYearKey].push(originalIndex);
                            break;

                        case 'bltwp_inspector':
                            // å…©å±¤åˆ†çµ„ï¼šæ•¸æ“šæº -> å¹´åˆ† -> äººå“¡ç´¢å¼•
                            const inspectorYearKey = year || 'ç„¡å¹´ä»½';
                            if (!groupedData[inspectorYearKey]) groupedData[inspectorYearKey] = [];
                            groupedData[inspectorYearKey].push(originalIndex);
                            break;

                        default:
                            // é»˜èªåˆ†çµ„ï¼šæ•¸æ“šæº -> äººå“¡ç´¢å¼•
                            if (!groupedData['æ‰€æœ‰äººå“¡']) groupedData['æ‰€æœ‰äººå“¡'] = [];
                            groupedData['æ‰€æœ‰äººå“¡'].push(originalIndex);
                    }
                });

                // ç”Ÿæˆ Accordion HTML - å‚³ésourceIdä»¥ä¾¿ç²å–åŸå§‹äººå“¡æ•¸æ“š
                accordionHTML += generateAccordion(sourceData.name.replace(/[ğŸ”¥ğŸš—ğŸ“ˆğŸ‘¨â€ğŸ”§âš¡â„ï¸ğŸ—ï¸]/g, '').trim(), groupedData, sourceId, 1);
            });

            container.innerHTML = accordionHTML;

            // åˆå§‹åŒ–æ‰€æœ‰accordionç‚ºå±•é–‹ç‹€æ…‹
            setTimeout(() => {
                // document.querySelectorAll('.dataset-content').forEach(content => {
                //     content.classList.add('expanded');
                // });
                document.querySelectorAll('.accordion-icon').forEach(icon => {
                    icon.className = 'fas fa-chevron-up accordion-icon';
                });
            }, 100);
        }
        // éè¿´ç”Ÿæˆ Accordion - ä¿®å¾©ï¼šä½¿ç”¨åŸå§‹äººå“¡ç´¢å¼•ç²å–äººå“¡æ•¸æ“š
        function generateAccordion(title, data, sourceId, level, parentId = '') {
            const currentId = parentId ? `${parentId}-${title.replace(/\s+/g, '-')}` : title.replace(/\s+/g, '-');
            let html = '';
            html += `<div class="accordion-level-${level}" id="accordion-${currentId}">`;

            // è¨ˆç®—ç¸½äººæ•¸
            let totalPersons = 0;

            if (level === 4 || (level < 4 && Array.isArray(data))) {
                // ç¬¬å››å±¤æˆ–æ•¸çµ„æ•¸æ“š
                if (Array.isArray(data)) {
                    totalPersons = data.length;
                }
            } else if (level < 4) {
                // è¨ˆç®—éæœ€å¾Œä¸€å±¤çš„äººæ•¸
                Object.keys(data).forEach(key => {
                    if (Array.isArray(data[key])) {
                        totalPersons += data[key].length;
                    } else if (typeof data[key] === 'object') {
                        Object.keys(data[key]).forEach(subKey => {
                            if (Array.isArray(data[key][subKey])) {
                                totalPersons += data[key][subKey].length;
                            } else if (typeof data[key][subKey] === 'object') {
                                Object.keys(data[key][subKey]).forEach(subSubKey => {
                                    if (Array.isArray(data[key][subKey][subSubKey])) {
                                        totalPersons += data[key][subKey][subSubKey].length;
                                    }
                                });
                            }
                        });
                    }
                });
            }

            // ç²å–é©åˆçš„åœ–æ¨™å’Œemoji
            const iconHtml = getIconByLevelAndType(level, title, sourceId);
            html += `
                <div class="dataset-header level-${level}" onclick="toggleAccordion(this)">
                    <div>
                        ${iconHtml}
                        <span>${title} (${totalPersons})</span>
                    </div>
                    <i class="fas fa-chevron-down accordion-icon"></i>
                </div>
                <div class="dataset-content">
            `;

            if (level < 4 && !Array.isArray(data)) {
                // éæœ€å¾Œä¸€å±¤ï¼Œç¹¼çºŒéè¿´
                const keys = Object.keys(data);
                if (keys.length > 0) {
                    keys.toSorted().forEach(key => {
                        if (data[key] && (Array.isArray(data[key]) || Object.keys(data[key]).length > 0)) {
                            html += generateAccordion(key, data[key], sourceId, level + 1, currentId);
                        }
                    });
                } else {
                    html += `
                        <div class="no-data" style="padding: 20px;">
                            <i class="fas fa-exclamation-circle"></i>
                            <p>æ­¤åˆ†é¡ç›®å‰æ²’æœ‰è³‡æ–™</p>
                        </div>
                    `;
                }
            } else if (Array.isArray(data) && data.length > 0) {
                // æœ€å¾Œä¸€å±¤ï¼Œé¡¯ç¤ºäººå“¡åˆ—è¡¨ - ä¿®å¾©ï¼šä½¿ç”¨åŸå§‹äººå“¡ç´¢å¼•ç²å–äººå“¡æ•¸æ“š
                data.forEach((personIndex, displayIndex) => {
                    const personId = `${currentId}-${displayIndex}`;
                    // å¾åŸå§‹æ•¸æ“šä¸­ç²å–äººå“¡å°è±¡
                    const person = personIndexMap[sourceId] ? personIndexMap[sourceId][personIndex] : null;

                    if (person) {
                        html += `
                            <div class="person-item" onclick="selectPerson('${personId}', '${sourceId}', ${personIndex})" 
                                 data-id="${personId}" 
                                 data-source="${sourceId}" 
                                 data-index="${personIndex}">
                                <div class="person-title">
                                    <i class="fas fa-user"></i>
                                    ${getPersonTitle(person, sourceId)}
                                </div>
                                <div class="person-content">
                                    ${getPersonContent(person, sourceId)}
                                </div>
                            </div>
                        `;
                    } else {
                        console.warn(`æ‰¾ä¸åˆ°äººå“¡æ•¸æ“š: sourceId=${sourceId}, index=${personIndex}`);
                    }
                });
            } else {
                html += `
                    <div class="no-data" style="padding: 20px;">
                        <i class="fas fa-exclamation-circle"></i>
                        <p>æ­¤åˆ†é¡ç›®å‰æ²’æœ‰è³‡æ–™</p>
                    </div>
                `;
            }

            html += `
                </div>
            </div>
            `;
            return html;
        }
        // æ ¹æ“šå±¤ç´šå’Œé¡å‹ç²å–åœ–æ¨™å’Œemoji - ç°¡åŒ–emojié¡¯ç¤º
        function getIconByLevelAndType(level, title, sourceId) {
            switch (level) {
                case 1:
                    // ç¬¬ä¸€å±¤ï¼šåªæœ‰æ•¸æ“šæºé¡¯ç¤ºemoji
                    const source = DATA_SOURCES.find(s => s.id === sourceId);
                    return source && source.emoji ? `<span style="font-size: 1.2em; margin-right: 8px;">${source.emoji}</span>` : '<i class="fas fa-database" style="margin-right: 8px;"></i>';
                case 2:
                    // ç¬¬äºŒå±¤ï¼šåªé¡¯ç¤ºåœ–æ¨™ï¼Œä¸é¡¯ç¤ºemoji
                    if (title.includes('Class') || title.includes('ç´šåˆ¥')) {
                        return '<i class="fas fa-tag" style="margin-right: 8px;"></i>';
                    } else if (title.includes('Service') || title.includes('Registered')) {
                        return '<i class="fas fa-tools" style="margin-right: 8px;"></i>';
                    } else if (title.includes('Permitted')) {
                        return '<i class="fas fa-check-circle" style="margin-right: 8px;"></i>';
                    } else if (title.includes('Grade')) {
                        return '<i class="fas fa-chart-bar" style="margin-right: 8px;"></i>';
                    } else if (/^\d{4}$/.test(title)) { // å¹´ä»½
                        return '<i class="fas fa-calendar-alt" style="margin-right: 8px;"></i>';
                    } else if (title === 'æœªåˆ†é¡') {
                        return '<i class="fas fa-question-circle" style="margin-right: 8px;"></i>';
                    } else {
                        return '<i class="fas fa-folder" style="margin-right: 8px;"></i>';
                    }
                case 3:
                    // ç¬¬ä¸‰å±¤
                    if (/^\d{4}$/.test(title)) { // å¹´ä»½
                        return '<i class="fas fa-calendar-alt" style="margin-right: 8px;"></i>';
                    } else if (title === 'Grade Code' || title.includes('Grade')) {
                        return '<i class="fas fa-chart-bar" style="margin-right: 8px;"></i>';
                    } else if (title === 'ç„¡ç´šåˆ¥' || title === 'ç„¡å¹´ä»½') {
                        return '<i class="fas fa-question-circle" style="margin-right: 8px;"></i>';
                    } else {
                        return '<i class="fas fa-folder-open" style="margin-right: 8px;"></i>';
                    }
                case 4:
                    // ç¬¬å››å±¤
                    return '<i class="fas fa-users" style="margin-right: 8px;"></i>';
                default:
                    return '<i class="fas fa-file" style="margin-right: 8px;"></i>';
            }
        }
        // çµ±ä¸€äººå“¡æ¨™é¡Œæå–å‡½æ•¸ - ç¢ºä¿æ‰€æœ‰åœ°æ–¹ä½¿ç”¨ç›¸åŒçš„é‚è¼¯
        function getPersonTitle(person, sourceId) {
            let title = '';
            switch (sourceId) {
                case 'gas_gi':
                    title = person['Chinese Name'] || person['English Name'] || 'Unknown';
                    break;
                case 'vehicle_mechanics':
                    title = person['Name (in Chinese)'] || person['Name (in English)'] || 'Unknown';
                    break;
                case 'lift_worker':
                case 'escalator_worker':
                case 'lift_engineer':
                case 'escalator_engineer':
                    title = person['Chinese Name'] || person['English Name'] || 'Unknown';
                    break;
                case 'electrical_worker':
                    title = person['Chinese Name'] || person['English Name'] || 'Unknown';
                    break;
                case 'hac_mfr':
                    title = person['Chinese Name'] || person['English Name'] || 'Unknown';
                    break;
                case 'bltwp_inspector':
                    title = person['å§“å'] || 'Unknown';
                    break;
                default:
                    title = 'Unknown';
            }
            return title.trim() || 'Unknown';
        }
        // ç²å–äººå“¡å…§å®¹ - ç¢ºä¿èˆ‡è©³ç´°ä¿¡æ¯ä½¿ç”¨ç›¸åŒçš„æ•¸æ“šæº
        function getPersonContent(person, sourceId) {
            let content = '';
            let name = '';
            let regNo = '';

            // ä½¿ç”¨çµ±ä¸€çš„æ•¸æ“šæå–é‚è¼¯
            switch (sourceId) {
                case 'gas_gi':
                    name = person['Chinese Name'] || person['English Name'] || '';
                    regNo = person['RGI No.'] || '';
                    content = ``;
                    if (person['Chinese Name'] && person['English Name']) {
                        content += `${person['English Name']}<br/>`;
                    }
                    if (regNo) content += `RGIè™Ÿç¢¼ï¼š${regNo}`;
                    break;
                case 'vehicle_mechanics':
                    name = person['Name (in Chinese)'] || person['Name (in English)'] || '';
                    regNo = person['Registration Number'] || '';
                    content = ``;
                    if (person['Name (in Chinese)'] && person['Name (in English)']) {
                        content += `${person['Name (in English)']}<br/>`;
                    }
                    if (regNo) content += `è¨»å†Šè™Ÿç¢¼ï¼š${regNo}`;
                    break;
                case 'lift_worker':
                case 'escalator_worker':
                case 'lift_engineer':
                case 'escalator_engineer':
                    name = person['Chinese Name'] || person['English Name'] || '';
                    const regField = sourceId.includes('lift') ?
                        (sourceId.includes('worker') ? 'Registered Lift Worker No.' : 'Registered Lift Engineer No.') :
                        (sourceId.includes('worker') ? 'Registered Escalator Worker No.' : 'Registered Escalator Engineer No.');
                    regNo = person[regField] || '';
                    content = ``;
                    if (person['Chinese Name'] && person['English Name']) {
                        content += `${person['English Name']}<br/>`;
                    }
                    if (regNo) content += `è¨»å†Šè™Ÿç¢¼ï¼š${regNo}`;
                    break;
                case 'electrical_worker':
                    name = person['Chinese Name'] || person['English Name'] || '';
                    regNo = person['Registered Electrical Worker No.'] || '';
                    content = ``;
                    if (person['Chinese Name'] && person['English Name']) {
                        content += `${person['English Name']}<br/>`;
                    }
                    if (regNo) content += `è¨»å†Šè™Ÿç¢¼ï¼š${regNo}`;
                    break;
                case 'hac_mfr':
                    name = person['Chinese Name'] || person['English Name'] || '';
                    regNo = person['Registration Number'] || '';
                    content = ``;
                    if (person['Chinese Name'] && person['English Name']) {
                        content += `${person['English Name']}<br/>`;
                    }
                    if (regNo) content += `è¨»å†Šè™Ÿç¢¼ï¼š${regNo}`;
                    break;
                case 'bltwp_inspector':
                    name = person['å§“å'] || '';
                    regNo = person['è¨»å†Šè™Ÿç¢¼'] || '';
                    content = ``;
                    if (regNo) content += `è¨»å†Šè™Ÿç¢¼ï¼š${regNo}`;
                    break;
            }
            return content;
        }
        // ç”Ÿæˆäººå“¡è©³ç´°è³‡è¨Š - ç¢ºä¿èˆ‡ç°¡è¦ä¿¡æ¯ä½¿ç”¨ç›¸åŒçš„æ•¸æ“š
        function generatePersonDetails(person, sourceId) {
            let details = '';

            // çµ±ä¸€çš„å§“åæå–é‚è¼¯ - èˆ‡ getPersonContent ä¿æŒä¸€è‡´
            let chineseName = '';
            let englishName = '';
            let regNo = '';

            // ä½¿ç”¨èˆ‡ getPersonContent ç›¸åŒçš„é‚è¼¯æå–æ•¸æ“š
            switch (sourceId) {
                case 'gas_gi':
                    chineseName = person['Chinese Name'] || '';
                    englishName = person['English Name'] || '';
                    regNo = person['RGI No.'] || '';
                    break;
                case 'vehicle_mechanics':
                    chineseName = person['Name (in Chinese)'] || '';
                    englishName = person['Name (in English)'] || '';
                    regNo = person['Registration Number'] || '';
                    break;
                case 'lift_worker':
                case 'escalator_worker':
                case 'lift_engineer':
                case 'escalator_engineer':
                    chineseName = person['Chinese Name'] || '';
                    englishName = person['English Name'] || '';
                    const regField = sourceId.includes('lift') ?
                        (sourceId.includes('worker') ? 'Registered Lift Worker No.' : 'Registered Lift Engineer No.') :
                        (sourceId.includes('worker') ? 'Registered Escalator Worker No.' : 'Registered Escalator Engineer No.');
                    regNo = person[regField] || '';
                    break;
                case 'electrical_worker':
                    chineseName = person['Chinese Name'] || '';
                    englishName = person['English Name'] || '';
                    regNo = person['Registered Electrical Worker No.'] || '';
                    break;
                case 'hac_mfr':
                    chineseName = person['Chinese Name'] || '';
                    englishName = person['English Name'] || '';
                    regNo = person['Registration Number'] || '';
                    break;
                case 'bltwp_inspector':
                    chineseName = person['å§“å'] || '';
                    regNo = person['è¨»å†Šè™Ÿç¢¼'] || '';
                    break;
            }

            // ç”Ÿæˆè©³ç´°è³‡è¨Š - ä½¿ç”¨çµ±ä¸€çš„æ•¸æ“š
            switch (sourceId) {
                case 'gas_gi':
                    details = `
                <div class="detail-row">
                    <div class="detail-label">ä¸­æ–‡å§“å:</div>
                    <div class="detail-value">${chineseName || 'N/A'}</div>
                </div>
                ${englishName ? `
                <div class="detail-row">
                    <div class="detail-label">è‹±æ–‡å§“å:</div>
                    <div class="detail-value">${englishName}</div>
                </div>
                ` : ''}
                ${regNo ? `
                <div class="detail-row">
                    <div class="detail-label">RGI è™Ÿç¢¼:</div>
                    <div class="detail-value">${regNo}</div>
                </div>
                ` : ''}
                <div class="detail-row">
                    <div class="detail-label">ç´šåˆ¥:</div>
                    <div class="detail-value">Class ${(person.classes || []).join(', ') || 'N/A'}</div>
                </div>
            `;
                    break;
                case 'vehicle_mechanics':
                    details = `
                <div class="detail-row">
                    <div class="detail-label">ä¸­æ–‡å§“å:</div>
                    <div class="detail-value">${chineseName || 'N/A'}</div>
                </div>
                ${englishName ? `
                <div class="detail-row">
                    <div class="detail-label">è‹±æ–‡å§“å:</div>
                    <div class="detail-value">${englishName}</div>
                </div>
                ` : ''}
                ${regNo ? `
                <div class="detail-row">
                    <div class="detail-label">è¨»å†Šè™Ÿç¢¼:</div>
                    <div class="detail-value">${regNo}</div>
                </div>
                ` : ''}
                <div class="detail-row">
                    <div class="detail-label">åˆ°æœŸæ—¥:</div>
                    <div class="detail-value">${person['Expiry Date'] || 'N/A'}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">è¨»å†Šæœå‹™é¡åˆ¥:</div>
                    <div class="detail-value">${person['Registered Service Class'] || 'N/A'}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">æœå‹™ç¯„åœ:</div>
                    <div class="detail-value">${person['Service Scope'] || 'N/A'}</div>
                </div>
            `;
                    break;
                case 'lift_worker':
                case 'escalator_worker':
                    const type = sourceId === 'lift_worker' ? 'å‡é™æ©Ÿ' : 'è‡ªå‹•æ¢¯';
                    details = `
                <div class="detail-row">
                    <div class="detail-label">ä¸­æ–‡å§“å:</div>
                    <div class="detail-value">${chineseName || 'N/A'}</div>
                </div>
                ${englishName ? `
                <div class="detail-row">
                    <div class="detail-label">è‹±æ–‡å§“å:</div>
                    <div class="detail-value">${englishName}</div>
                </div>
                ` : ''}
                ${regNo ? `
                <div class="detail-row">
                    <div class="detail-label">è¨»å†Šè™Ÿç¢¼:</div>
                    <div class="detail-value">${regNo}</div>
                </div>
                ` : ''}
                <div class="detail-row">
                    <div class="detail-label">ç´šåˆ¥:</div>
                    <div class="detail-value">Class ${(person.classes || []).join(', ') || 'N/A'}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">åˆ°æœŸæ—¥:</div>
                    <div class="detail-value">${person['Expiry Date'] || 'N/A'}</div>
                </div>
                ${person['Suspension End Date'] ? `
                <div class="detail-row">
                    <div class="detail-label">åœç‰ŒçµæŸæ—¥æœŸ:</div>
                    <div class="detail-value">${person['Suspension End Date']}</div>
                </div>
                ` : ''}
            `;
                    break;
                case 'lift_engineer':
                case 'escalator_engineer':
                    const engType = sourceId === 'lift_engineer' ? 'Lift' : 'Escalator';
                    details = `
                <div class="detail-row">
                    <div class="detail-label">ä¸­æ–‡å§“å:</div>
                    <div class="detail-value">${chineseName || 'N/A'}</div>
                </div>
                ${englishName ? `
                <div class="detail-row">
                    <div class="detail-label">è‹±æ–‡å§“å:</div>
                    <div class="detail-value">${englishName}</div>
                </div>
                ` : ''}
                ${regNo ? `
                <div class="detail-row">
                    <div class="detail-label">è¨»å†Šè™Ÿç¢¼:</div>
                    <div class="detail-value">${regNo}</div>
                </div>
                ` : ''}
                <div class="detail-row">
                    <div class="detail-label">åˆ°æœŸæ—¥:</div>
                    <div class="detail-value">${person['Expiry Date'] || 'N/A'}</div>
                </div>
                ${person['Suspension End Date'] ? `
                <div class="detail-row">
                    <div class="detail-label">åœç‰ŒçµæŸæ—¥æœŸ:</div>
                    <div class="detail-value">${person['Suspension End Date']}</div>
                </div>
                ` : ''}
            `;
                    break;
                case 'electrical_worker':
                    details = `
                <div class="detail-row">
                    <div class="detail-label">ä¸­æ–‡å§“å:</div>
                    <div class="detail-value">${chineseName || 'N/A'}</div>
                </div>
                ${englishName ? `
                <div class="detail-row">
                    <div class="detail-label">è‹±æ–‡å§“å:</div>
                    <div class="detail-value">${englishName}</div>
                </div>
                ` : ''}
                ${regNo ? `
                <div class="detail-row">
                    <div class="detail-label">è¨»å†Šè™Ÿç¢¼:</div>
                    <div class="detail-value">${regNo}</div>
                </div>
                ` : ''}
                <div class="detail-row">
                    <div class="detail-label">ç´šåˆ¥ä»£ç¢¼:</div>
                    <div class="detail-value">${person['Grade Code'] || 'N/A'}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">åˆ°æœŸæ—¥:</div>
                    <div class="detail-value">${person['Expiry Date'] || 'N/A'}</div>
                </div>
                ${(person.permittedWorks && person.permittedWorks.length > 0) ? `
                <div class="detail-row">
                    <div class="detail-label">è¨±å¯å·¥ä½œ:</div>
                    <div class="detail-value">${person.permittedWorks.join(', ')}</div>
                </div>
                ` : ''}
            `;
                    break;
                case 'hac_mfr':
                    details = `
                <div class="detail-row">
                    <div class="detail-label">ä¸­æ–‡å§“å:</div>
                    <div class="detail-value">${chineseName || 'N/A'}</div>
                </div>
                ${englishName ? `
                <div class="detail-row">
                    <div class="detail-label">è‹±æ–‡å§“å:</div>
                    <div class="detail-value">${englishName}</div>
                </div>
                ` : ''}
                ${regNo ? `
                <div class="detail-row">
                    <div class="detail-label">è¨»å†Šè™Ÿç¢¼:</div>
                    <div class="detail-value">${regNo}</div>
                </div>
                ` : ''}
                <div class="detail-row">
                    <div class="detail-label">åˆ°æœŸæ—¥:</div>
                    <div class="detail-value">${person['Expiry Date'] || 'N/A'}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">è¨»å†Šé¡åˆ¥:</div>
                    <div class="detail-value">${person['Registered Class'] || 'N/A'}</div>
                </div>
            `;
                    break;
                case 'bltwp_inspector':
                    details = `
                <div class="detail-row">
                    <div class="detail-label">å§“å:</div>
                    <div class="detail-value">${chineseName || 'N/A'}</div>
                </div>
                ${regNo ? `
                <div class="detail-row">
                    <div class="detail-label">è¨»å†Šè™Ÿç¢¼:</div>
                    <div class="detail-value">${regNo}</div>
                </div>
                ` : ''}
                ${person['è¯çµ¡è³‡æ–™'] ? `
                <div class="detail-row">
                    <div class="detail-label">è¯çµ¡è³‡æ–™:</div>
                    <div class="detail-value">${person['è¯çµ¡è³‡æ–™']}</div>
                </div>
                ` : ''}
                ${person['è¨»å†Šæœ‰æ•ˆåˆ°æœŸæ—¥'] ? `
                <div class="detail-row">
                    <div class="detail-label">è¨»å†Šæœ‰æ•ˆåˆ°æœŸæ—¥:</div>
                    <div class="detail-value">${person['è¨»å†Šæœ‰æ•ˆåˆ°æœŸæ—¥']}</div>
                </div>
                ` : ''}
            `;
                    break;
            }

            return `
        <div class="person-details">
            ${details}
            <div class="detail-row">
                <div class="detail-label">è³‡æ–™ä¾†æº:</div>
                <div class="detail-value">
                    <a href="${DATA_SOURCES.find(s => s.id === sourceId).url.replace(PROXY_URL + '/', '')}" target="_blank" style="color: #283593;">
                        æ©Ÿé›»å·¥ç¨‹ç½² (EMSD)
                    </a>
                </div>
            </div>
        </div>
    `;
        }
        // åˆ‡æ› Accordion
        function toggleAccordion(element) {
            const content = element.nextElementSibling;
            const icon = element.querySelector('.accordion-icon');

            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                if (icon) icon.className = 'fas fa-chevron-down accordion-icon';
            } else {
                content.classList.add('expanded');
                if (icon) icon.className = 'fas fa-chevron-up accordion-icon';
            }
        }
        // ä¿®æ”¹é¸æ“‡äººå“¡å‡½æ•¸ - ä½¿ç”¨åŸå§‹äººå“¡ç´¢å¼•
        function selectPerson(personId, sourceId, originalIndex) {
            const index = originalIndex !== undefined ? originalIndex : parseInt(personId.split('-').pop());

            // ç§»é™¤æ‰€æœ‰æ´»èºç‹€æ…‹
            document.querySelectorAll('.person-item').forEach(item => {
                item.classList.remove('active');
                // ç§»é™¤ç¾æœ‰çš„è©³ç´°è³‡è¨Š
                const existingDetails = item.querySelector('.person-details');
                if (existingDetails) {
                    existingDetails.remove();
                }
            });

            // æ·»åŠ ç•¶å‰æ´»èºç‹€æ…‹
            const item = document.querySelector(`.person-item[data-id="${personId}"]`);
            if (item) {
                item.classList.add('active');
                // ç²å–äººå“¡æ•¸æ“š - å¾åŸå§‹æ•¸æ“šä¸­ç²å–
                const sourceData = allData[sourceId];
                if (sourceData && sourceData.data[index]) {
                    const person = sourceData.data[index];
                    const details = generatePersonDetails(person, sourceId);
                    item.insertAdjacentHTML('beforeend', details);
                }
                // æ»¾å‹•åˆ°é¸ä¸­çš„é …ç›®
                item.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }
        // é‡ç½®è¡¨å–®
        function resetForm() {
            allData = {};
            updateStatistics(0);
            document.getElementById('accordion-container').innerHTML = `
                <div class="no-data">
                    <i class="fas fa-database"></i>
                    <p>è«‹é¸æ“‡è³‡æ–™ä¾†æºä¸¦é»æ“Šã€Œè¼‰å…¥æ‰€æœ‰è³‡æ–™ã€æŒ‰éˆ•é–‹å§‹æŸ¥è©¢</p>
                </div>
            `;
            showNotification('å·²é‡ç½®æŸ¥è©¢', 'info');
        }
        // æ¸…é™¤æ‰€æœ‰ç·©å­˜
        function clearAllCache() {
            if (!db) {
                showNotification('ç€è¦½å™¨è³‡æ–™åº«æœªåˆå§‹åŒ–', 'error');
                return;
            }
            if (!confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰ç·©å­˜è³‡æ–™å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤éŠ·ã€‚')) {
                return;
            }
            const transaction = db.transaction([...DATA_SOURCES.map(s => s.id), 'cache_status'], 'readwrite');
            DATA_SOURCES.forEach(source => {
                const store = transaction.objectStore(source.id);
                store.clear();
                cacheStatus[source.id] = 'not_cached';
                updateSourceCount(source.id, 0);
                // ç§»é™¤æŒ‰éˆ•çš„ active ç‹€æ…‹
                const button = document.getElementById(`source-btn-${source.id}`);
                if (button) {
                    button.classList.remove('active');
                }
            });
            const statusStore = transaction.objectStore('cache_status');
            statusStore.clear();
            transaction.oncomplete = function () {
                updateCacheStatus();
                showNotification('æ‰€æœ‰ç·©å­˜å·²æ¸…é™¤', 'success');
            };
            transaction.onerror = function (event) {
                console.error('æ¸…é™¤ç·©å­˜å¤±æ•—:', event.target.error);
                showNotification('æ¸…é™¤ç·©å­˜å¤±æ•—', 'error');
            };
        }
        // é¡¯ç¤ºé€šçŸ¥
        function showNotification(message, type = 'info') {
            // ç§»é™¤ç¾æœ‰é€šçŸ¥
            const existingNotification = document.querySelector('.notification');
            if (existingNotification) {
                existingNotification.remove();
            }
            // å‰µå»ºé€šçŸ¥å…ƒç´ 
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;
            // æ·»åŠ åˆ°æ–‡æª”
            document.body.appendChild(notification);
            // 3ç§’å¾Œç§»é™¤
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
    </script>
</body>

</html>